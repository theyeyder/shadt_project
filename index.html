<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> SHADT- Login</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="login-body">

  <div class="login-overlay">
    <div class="container h-100">
      <div class="row justify-content-center">

        <div class="col-md-5">
          <div class="card shadow-lg login-card">

            <!-- Card centrada -->
            <div class="card-body p-4 text-center">

              <!-- Logo -->
              <div class="text-center mb-3">
                <img src="img/logo-shadt.png" alt="SHADT" style="max-height:60px;">
              </div>

              <!-- Título (COMENTADO ) -->
              <h1 class="text-center mb-1 shadt-logo"><!--SHADT--></h1>

              <!-- Subtítulo (COMENTADO ) -->
              <h6 class="text-center text-muted mb-4">
                <!--Salud Hospitalaria al Alcance de Todos-->
              </h6>

              <!-- Campo Conexión (activo) -->
              <div class="mb-3 text-center">
                <label for="conexion" class="form-label w-100 text-center">Conexión</label>
                <select class="form-select text-center" id="conexion">
                  <option value="">Seleccione</option>
                  <option value="Salud">Salud</option>
                  <option value="Prueba">Prueba</option>
                  <option value="Soporte">Soporte</option>
                  <option value="Admin">Admin</option>
                  <option value="Desarrollador">Desarrollador</option>
                </select>
              </div>

              <!-- FORMULARIO -->
              <form id="login-form">

                <!-- Usuario -->
                <div class="mb-3">
                  <label for="usuario" class="form-label w-100 text-center">Usuario</label>
                  <input
                    type="text"
                    class="form-control text-center"
                    id="usuario"
                    placeholder="Ingrese su usuario"
                    required
                  >
                </div>

                <!-- Contraseña -->
                <div class="mb-3">
                  <label for="password" class="form-label w-100 text-center">Contraseña</label>
                  <input
                    type="password"
                    class="form-control text-center"
                    id="password"
                    placeholder="Ingrese su contraseña"
                    required
                  >
                </div>

                <!-- Cambiar contraseña -->
                <div class="d-flex justify-content-center mb-3">
                  <a href="#" class="link-cambiar-pass">Cambiar contraseña</a>
                </div>

                <!-- Botón ingresar -->
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary btn-lg">
                    Ingresar
                  </button>
                </div>

              </form>

            </div> <!-- card-body -->

          </div> <!-- card -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // LOGIN: roles técnicos (Desarrollador, Admin, Prueba, Soporte)
    // y usuarios de Salud creados en Configuración (shadt_users)
    document.getElementById('login-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const conexionSelect = document.getElementById('conexion');
      const conexion = conexionSelect.value;
      const usuarioInput = document.getElementById('usuario');
      const passwordInput = document.getElementById('password');

      const usuario = usuarioInput.value.trim();
      const password = passwordInput.value.trim();

      if (!conexion) {
        alert('Seleccione un tipo de conexión.');
        conexionSelect.focus();
        return;
      }

      if (!usuario) {
        alert('Ingrese el usuario.');
        usuarioInput.focus();
        return;
      }

      if (!password) {
        alert('Ingrese la contraseña.');
        passwordInput.focus();
        return;
      }

      const rolesTecnicos = ['Desarrollador','Admin','Prueba','Soporte'];

      // 1) ROLES TÉCNICOS: usuario = conexión, contraseña = usuario
      if (rolesTecnicos.includes(conexion) && conexion !== 'Salud') {
        // Aquí la regla es simple: usuario y contraseña iguales al nombre de la conexión
        if (usuario !== conexion || password !== conexion) {
          alert('Para la conexión "' + conexion + '" el usuario y la contraseña deben ser exactamente: ' + conexion);
          return;
        }

        const shadtUser = {
          nombre: conexion,        // Lo que se mostrará en módulos y sidebars
          usuario: usuario,        // ej: "Desarrollador"
          conexion: conexion
        };

        try {
          localStorage.setItem('shadt_user', JSON.stringify(shadtUser));
        } catch (e) {
          console.error('Error guardando shadt_user en localStorage', e);
        }

        window.location.href = 'modulos.html';
        return;
      }

      // 2) USUARIOS DE SALUD: se validan contra Configuración (shadt_users)
      if (conexion === 'Salud') {
        const raw = localStorage.getItem('shadt_users');
        const usuariosConfig = raw ? JSON.parse(raw) : [];

        if (!usuariosConfig.length) {
          alert('No hay usuarios configurados. Cree usuarios de Salud en el módulo Configuración.');
          return;
        }

        // Buscar usuario de Salud activo con login y contraseña correctos
        const encontrado = usuariosConfig.find(u =>
          u.usuario === usuario &&
          u.pass === password &&
          (u.estado === 'activo' || !u.estado) &&
          (u.conexion === 'Salud' || !u.conexion)
        );

        if (!encontrado) {
          alert('Usuario de Salud o contraseña incorrectos, o usuario inactivo.');
          return;
        }

        // Nombre mostrado en la app (Ej: "Eyder Arroyo Vega")
        const nombreParaMostrar = encontrado.nombre || encontrado.usuario || 'Usuario';

        const shadtUser = {
          nombre: nombreParaMostrar,   // Nombre mostrado
          usuario: encontrado.usuario, // login (eyderav)
          conexion: 'Salud',
          cedula: encontrado.cedula || ''
        };

        try {
          localStorage.setItem('shadt_user', JSON.stringify(shadtUser));
        } catch (e) {
          console.error('Error guardando shadt_user en localStorage', e);
        }

        window.location.href = 'modulos.html';
        return;
      }

      // Seguridad: si por alguna razón llega aquí con otra conexión no contemplada
      alert('Conexión no válida o no soportada.');
    });
  </script>
</body>
</html>
