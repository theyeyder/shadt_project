<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SHADT - Informes</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="css/styles.css">

  <!-- Estilos específicos para Informes -->
  <style>
    .inf-label-box {
      background-color: #7FE6F3;
      color: #000;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 2px;
      text-align: center;
      display: inline-block;
    }

    .inf-input {
      height: 28px;
      font-size: 0.9rem;
      padding: 2px 8px;
      text-align: center;
    }

    .inf-title-bar {
      background-color: #09d396;
      padding: 2px 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 2px;
      display: inline-block;
    }

    .inf-select-small {
      height: 28px;
      font-size: 0.9rem;
      padding: 2px 8px;
    }

    .inf-center-img {
      max-width: 200px;
      height: auto;
    }

    .inf-icon-btn {
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
    }

    .inf-icon {
      width: 42px;
      height: auto;
    }

    .inf-msg {
      font-size: 0.8rem;
    }

    /* SOLO IMPRIMIR LA ZONA DEL INFORME */
    @media print {

      body * {
        visibility: hidden !important;
      }

      #print-area, #print-area * {
        visibility: visible !important;
      }

      #print-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }

    }
  </style>
</head>
<body class="app-body">

<!-- BOTÓN MENU LATERAL (solo móvil) -->
<button
  id="sidebarToggle"
  type="button"
  class="btn btn-primary d-md-none sidebar-toggle-btn"
  aria-label="Abrir menú"
>
  ☰
</button>

<div class="d-flex">

  <!-- SIDEBAR -->
  <aside class="sidebar bg-dark text-white">
    <div class="p-3 text-center border-bottom border-secondary">
      <div class="shadt-logo-side mb-1">SHADT</div>
    </div>

    <nav class="nav flex-column p-2 mt-2">
      <span class="text-uppercase text-muted small mb-2">Módulos</span>
      <a href="admision.html" class="nav-link text-white">ADMISIÓN</a>
      <a href="signos_vitales.html" class="nav-link text-white">SIGNOS VITALES</a>
      <a href="historia_clinica.html" class="nav-link text-white">HISTORIA CLÍNICA</a>
      <a href="salida.html" class="nav-link text-white">SALIDA</a>
      <a href="acostar.html" class="nav-link text-white">ACOSTAR</a>
      <a href="estadia_alta.html" class="nav-link text-white">ESTADÍA Y ALTA PACIENTE</a>
      <a href="informes.html" class="nav-link text-white active">INFORMES</a>
    </nav>

    <div class="mt-auto p-3 border-top border-secondary small">
      <div>Usuario: <strong id="shadt-username">Desarrollador</strong></div>
      <a href="modulos.html" class="text-decoration-none text-light d-block mb-1">
        Ir a módulos
      </a>
      <a href="index.html" class="text-decoration-none text-danger">
        Cerrar sesión
      </a>
    </div>
  </aside>

  <!-- CONTENIDO -->
  <main class="flex-grow-1 app-main app-bg-medico">
    <div class="container py-4">

      <div id="inf-msg" class="inf-msg text-primary mb-2"></div>

      <div class="card bg-semitransparent">
        <div class="card-body" id="print-area">

          <!-- FILA SUPERIOR: INFORMES + TITULO -->
          <div class="row mb-4 align-items-center">

            <!-- Combo INFORMES -->
            <div class="col-md-4 d-flex align-items-center gap-2">
              <span class="inf-label-box">Informes</span>
              <select id="tipoInforme" class="form-select inf-select-small">
                <option selected>Pacientes admisionados</option>
                <option>Pacientes dados de alta</option>
                <option>Historias clínicas</option>
                <option>Signos vitales</option>
                <option>Pacientes hospitalizados</option>
              </select>
            </div>

            <!-- Título -->
            <div class="col-md-4 text-center mt-3 mt-md-0">
              <span id="tituloInforme" class="inf-title-bar">Pacientes admisionados</span>
            </div>

            <div class="col-md-4"></div>
          </div>

          <!-- IMAGEN CENTRAL (opcional) -->
          <div class="row mb-4">
            <div class="col-12 text-center">
              <!-- <img src="img/icon-informes-pacientes.png" class="inf-center-img"> -->
            </div>
          </div>

          <!-- FECHAS -->
          <div class="row mb-3 align-items-center">

            <div class="col-md-4 d-flex justify-content-md-end mb-3 mb-md-0">
              <div class="text-center">
                <span class="inf-label-box mb-1 d-block">Fecha inicial</span>
                <input type="date" class="form-control inf-input" id="fechaInicial">
              </div>
            </div>

            <div class="col-md-4"></div>

            <div class="col-md-4 d-flex justify-content-md-start">
              <div class="text-center">
                <span class="inf-label-box mb-1 d-block">Fecha final</span>
                <input type="date" class="form-control inf-input" id="fechaFinal">
              </div>
            </div>

          </div>

          <!-- TIPO DE ARCHIVO -->
          <div class="row">
            <div class="col-12 text-center">
              <span class="fw-semibold" style="color:#0088aa;">Tipo de Archivo</span>
              <select id="tipoArchivo" class="form-select d-inline-block inf-select-small w-auto ms-1">
                <option selected>Seleccione formato</option>
                <option>PDF</option>
                <option>Excel</option>
                <option>CSV</option>
                <option>Vista en pantalla</option>
              </select>
            </div>
          </div>

          <!-- BOTÓN GENERAR -->
          <div class="row mt-3">
            <div class="col-12 text-center">
              <button type="button" id="btnGenerar" class="btn btn-primary btn-sm">
                Generar
              </button>
            </div>
          </div>

          <!-- RESULTADO DEL INFORME -->
          <div id="resultadoInforme" class="mt-3"></div>

          <!-- BOTÓN IMPRIMIR SOLO EL INFORME -->
          <div class="row mt-4">
            <div class="col-12 text-center">
              <button type="button" class="inf-icon-btn" id="btnImprimir">
                <img src="img/icon-imprimir.png" class="inf-icon" alt="Imprimir">
              </button>
              <div>Imprimir</div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </main>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /* ===== UTILIDADES BÁSICAS ===== */
  function setInfMsg(texto, tipo = 'info') {
    const msg = document.getElementById('inf-msg');
    msg.classList.remove('text-primary', 'text-danger', 'text-success');
    if (tipo === 'error') msg.classList.add('text-danger');
    else if (tipo === 'ok') msg.classList.add('text-success');
    else msg.classList.add('text-primary');
    msg.textContent = texto || '';
  }

  function keyPaciente(tipoId, numId) {
    return (tipoId || '') + '|' + (numId || '');
  }

  function getAdmisiones() {
    const raw = localStorage.getItem('shadt_admisiones');
    return raw ? JSON.parse(raw) : {};
  }

  function getHistorias() {
    const raw = localStorage.getItem('shadt_historias');
    return raw ? JSON.parse(raw) : {};
  }

  function getCamas() {
    const raw = localStorage.getItem('shadt_camas');
    return raw ? JSON.parse(raw) : {};
  }

  function getSignos() {
    const raw = localStorage.getItem('shadt_signos');
    return raw ? JSON.parse(raw) : [];
  }

  function parseDateSafe(str) {
    if (!str) return null;
    const d = new Date(str);
    if (!isNaN(d.getTime())) return d;

    // Intentar dd/mm/yyyy
    const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(str);
    if (m) {
      const dd = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10) - 1;
      const yyyy = parseInt(m[3], 10);
      const d2 = new Date(yyyy, mm, dd);
      if (!isNaN(d2.getTime())) return d2;
    }
    return null;
  }

  function inRange(dateStr, desdeStr, hastaStr) {
    if (!desdeStr && !hastaStr) return true;
    const d = parseDateSafe(dateStr);
    if (!d) return true; // si no se puede parsear, no filtramos

    let ok = true;
    if (desdeStr) {
      const dDesde = new Date(desdeStr + 'T00:00:00');
      if (d < dDesde) ok = false;
    }
    if (hastaStr) {
      const dHasta = new Date(hastaStr + 'T23:59:59');
      if (d > dHasta) ok = false;
    }
    return ok;
  }

  function buildTable(headers, rows) {
    if (!rows.length) {
      return '<p class="text-center text-muted mb-0">No hay datos para el criterio seleccionado.</p>';
    }

    let html = '<table class="table table-sm table-striped align-middle mb-0">';
    html += '<thead><tr>';
    headers.forEach(h => {
      html += '<th scope="col">' + h + '</th>';
    });
    html += '</tr></thead><tbody>';

    rows.forEach(r => {
      html += '<tr>';
      r.forEach(c => {
        html += '<td>' + (c == null ? '' : c) + '</td>';
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  /* ===== EXPORTAR A CSV / “EXCEL” ===== */
  function exportarDatos(headers, rows, tipoInforme, formato) {
    if (!rows.length) {
      alert('No hay datos para exportar.');
      return;
    }

    // Armamos un CSV sencillo
    const sep = ';';
    let contenido = '';
    contenido += headers.join(sep) + '\n';
    rows.forEach(r => {
      const linea = r.map(val => {
        const s = (val == null ? '' : String(val)).replace(/"/g, '""');
        return '"' + s + '"';
      }).join(sep);
      contenido += linea + '\n';
    });

    const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);

    const pref = tipoInforme.replace(/\s+/g, '_').toLowerCase();
    const hoy  = new Date().toISOString().slice(0, 10);

    if (formato === 'Excel') {
      a.download = pref + '_' + hoy + '.xls';  // Excel lo abre sin problema
    } else {
      a.download = pref + '_' + hoy + '.csv';
    }

    const a = document.createElement('a');
    a.href = url;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ===== LÓGICA DE INFORMES ===== */
  function generarInforme() {
    const tipoSel = document.getElementById('tipoInforme').value;
    const formato = document.getElementById('tipoArchivo').value;
    const fDesde  = document.getElementById('fechaInicial').value;
    const fHasta  = document.getElementById('fechaFinal').value;

    const contResultado = document.getElementById('resultadoInforme');

    let headers = [];
    let rows    = [];
    let titulo  = tipoSel;

    // --- PACIENTES ADMISIONADOS ---
    if (tipoSel === 'Pacientes admisionados') {
      const admisiones = getAdmisiones();
      headers = ['Tipo ID', 'Documento', 'Nombre', 'Fecha admisión', 'Hora', 'Síntomas', 'Estado'];

      Object.values(admisiones).forEach(a => {
        const fechaAdm = a.fecha || a.fechaUltMod || '';
        if (!inRange(fechaAdm, fDesde, fHasta)) return;
        rows.push([
          a.tipoId || '',
          a.numId  || '',
          a.nombre || '',
          fechaAdm,
          a.hora || '',
          a.sintomas || '',
          (a.estado || 'activa').toUpperCase()
        ]);
      });

    // --- PACIENTES DADOS DE ALTA ---
    } else if (tipoSel === 'Pacientes dados de alta') {
      const historias = getHistorias();
      headers = ['Tipo ID', 'Documento', 'Nombre', 'Diagnóstico', 'Decisión', 'Estado historia', 'Fecha último cambio'];

      Object.values(historias).forEach(h => {
        if (h.decision !== 'salida') return; // solo los dados de alta
        const fechaH = h.fechaUltMod || '';
        if (!inRange(fechaH, fDesde, fHasta)) return;
        rows.push([
          h.tipoId || '',
          h.numId  || '',
          h.nombre || '',
          h.diagnostico || '',
          'SALIDA',
          (h.estado || '').toUpperCase(),
          fechaH
        ]);
      });

    // --- HISTORIAS CLÍNICAS ---
    } else if (tipoSel === 'Historias clínicas') {
      const historias = getHistorias();
      headers = ['Tipo ID', 'Documento', 'Nombre', 'Diagnóstico', 'Enfermedad actual', 'Estado', 'Fecha último cambio'];

      Object.values(historias).forEach(h => {
        const fechaH = h.fechaUltMod || '';
        if (!inRange(fechaH, fDesde, fHasta)) return;
        rows.push([
          h.tipoId || '',
          h.numId  || '',
          h.nombre || '',
          h.diagnostico || '',
          h.enfActual   || '',
          (h.estado || 'abierta').toUpperCase(),
          fechaH
        ]);
      });

    // --- SIGNOS VITALES (REAL) ---
    } else if (tipoSel === 'Signos vitales') {
      const signos = getSignos();
      headers = ['Fecha', 'Hora', 'Tipo ID', 'Documento', 'Nombre', 'Temperatura', 'FC', 'FR', 'PA', 'SpO₂', 'Observación'];

      const lista = Array.isArray(signos) ? signos : Object.values(signos);
      lista.forEach(s => {
        const fechaSv = s.fecha || s.fechaHora || s.fechaRegistro || '';
        if (!inRange(fechaSv, fDesde, fHasta)) return;
        rows.push([
          fechaSv,
          s.hora || s.horaRegistro || '',
          s.tipoId || '',
          s.numId  || '',
          s.nombre || '',
          s.temp   || '',
          s.fc     || '',
          s.fr     || '',
          s.pa     || '',
          s.spo2   || '',
          s.observacion || ''
        ]);
      });

    // --- PACIENTES HOSPITALIZADOS ---
    } else if (tipoSel === 'Pacientes hospitalizados') {
      const camas = getCamas();
      headers = ['Cama', 'Tipo paciente', 'Nombre', 'Tipo ID', 'Documento', 'Tipo cama'];

      for (let i = 1; i <= 6; i++) {
        const c = camas[i];
        if (!c || c.type === 'none' || !c.patient) continue;
        const p = c.patient;
        rows.push([
          'Cama ' + i,
          (p.tipoPaciente || '').toUpperCase(),
          p.nombre || '',
          p.tipoId || '',
          p.numId  || '',
          p.tipoCama || ''
        ]);
      }
    }

    // Pintar tabla (vista en pantalla)
    contResultado.innerHTML = '<h5 class="mb-3">' + titulo + '</h5>' + buildTable(headers, rows);

    if (!rows.length) {
      setInfMsg('No se encontraron registros para el informe y rango de fechas seleccionado.', 'info');
    } else {
      setInfMsg('Informe generado correctamente.', 'ok');
    }

    // Si no seleccionó formato o escogió "Vista en pantalla", solo mostramos la tabla
    if (formato === 'Seleccione formato' || formato === 'Vista en pantalla') {
      return;
    }

    // PDF = usar impresión (el navegador permite guardar como PDF)
    if (formato === 'PDF') {
      setTimeout(() => {
        window.print();
      }, 200);
      return;
    }

    // Excel / CSV = descargar archivo
    if (formato === 'Excel' || formato === 'CSV') {
      exportarDatos(headers, rows, tipoSel, formato);
    }
  }

  /* ===== EVENTOS INICIALES ===== */
  document.addEventListener('DOMContentLoaded', function () {
    // Cambiar título según tipo de informe
    document.getElementById("tipoInforme").addEventListener("change", function() {
      document.getElementById("tituloInforme").innerText = this.value;
    });

    // Botón Generar
    document.getElementById('btnGenerar').addEventListener('click', function () {
      generarInforme();
    });

    // Botón Imprimir área (independiente del formato)
    document.getElementById('btnImprimir').addEventListener('click', function () {
      window.print();
    });

    // Fecha inicial/final por defecto = hoy
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    const hoyStr = `${yyyy}-${mm}-${dd}`;
    document.getElementById('fechaInicial').value = hoyStr;
    document.getElementById('fechaFinal').value   = hoyStr;

    setInfMsg('Seleccione el tipo de informe, el rango de fechas (opcional), el formato y presione "Generar".');

    // Mostrar usuario en la sidebar
    const spanUser = document.getElementById('shadt-username');
    if (spanUser) {
      try {
        const raw = localStorage.getItem('shadt_user');
        if (raw) {
          const user = JSON.parse(raw);
          if (user && user.nombre) {
            spanUser.textContent = user.nombre;
          }
        }
      } catch (e) {
        console.error('Error leyendo shadt_user', e);
      }
    }

    // Toggle de sidebar en móvil
    const btnToggle = document.getElementById('sidebarToggle');
    if (btnToggle) {
      btnToggle.addEventListener('click', function () {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          sidebar.classList.toggle('show');
        }
      });
    }
  });
</script>

</body>
</html>
